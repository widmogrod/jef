/*! jef 2014-06-25 */
!function(a,b){"object"==typeof exports?module.exports=b(require("./events.js")):"function"==typeof define&&define.amd?define(["jef/events"],b):(a.jef=a.jef||{},a.jef.stream=b(a.jef.events))}(this,function(a,b){"use strict";function c(b){a.call(this),this.options=b||{},this.chain=[],this.buffer=[],this.filtered=!1}var d=Function.prototype.call.bind(Array.prototype.slice);return c.constructor=c,c.prototype=new a,c.prototype.pipe=function(a,c,d){return 0>c&&(c+=this.buffer.length),this.buffer.forEach(function(e,f){b!==c&&c>f||b!==d&&--d<0||a.apply(a,e)}.bind(this)),this.on("data",a)},c.prototype.last=function(a){return this.pipe(a,-1,1)},c.prototype.first=function(a){return this.pipe(a,0,1)},c.prototype.take=function(a,b,d){return this.chain.push(new c({take:{limit:a,skip:b||0,allowEmpty:!!d}})),this.chain[this.chain.length-1]},c.prototype.map=function(a){return this.chain.push(new c({apply:this.options.apply,map:a})),this.chain[this.chain.length-1]},c.prototype.accept=function(a){return this.chain.push(new c({apply:this.options.apply,filter:function(){return!a.apply(a,arguments)}})),this.chain[this.chain.length-1]},c.prototype.reject=function(a){return this.chain.push(new c({apply:this.options.apply,filter:a})),this.chain[this.chain.length-1]},c.prototype.push=function(a){if(a=d(arguments),this.filtered=!1,this.options.filter&&this.options.filter.apply(this.options.filter,a))return this.filtered=!0,this.trigger("out",a,this);if(this.options.map&&(a="function"==typeof this.options.map?this.options.map.apply(this,a):this.options.map,a=Array.isArray(a)?a:[a]),this.buffer.push(a),this.options.take){var b=this.buffer.length,c=b-this.options.take.skip,e=c-this.options.take.limit;if(e=0>e?0:e,a=this.buffer.slice(e,c),!this.options.allowEmpty&&a.length!==this.options.take.limit)return this}return this.trigger("data",a,this),this.chain.forEach(function(b){b.push.apply(b,a)}),this},c.prototype.merge=function(a){return c.when(this,a)},c.prototype.destroy=function(){this.options.destroy&&this.options.destroy(),this.chain.forEach(function(a){a.destroy()}),c.call(this)},c.flat=function(){var a=d(arguments),b=[],e=new c({destroy:function(){a.forEach(function(a,c){a.off("data",b[c])})}});return a.forEach(function(a,c){a.on("data",b[c]=function(){e.push.apply(e,arguments)})}),e},c.when=function(){var a=d(arguments),b=[],e=new Array(a.length),f=new Array(a.length),g=new c({filter:function(a){return-1!==a.called.indexOf(!1)},map:function(a){return a.arguments},destroy:function(){a.forEach(function(a,c){a.off("out",b[c]),a.off("data",b[c])})}});return a.forEach(function(a,c){f[c]=!1,b[c]=function(a){f[c]=!this.filtered,e[c]=a,g.push({arguments:e,called:f})},a.on("out",b[c]),a.last(b[c])}),g},c});