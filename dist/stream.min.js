/*! jef 2014-07-21 */
!function(a,b){"object"==typeof exports?module.exports=b(require("./events.js")):"function"==typeof define&&define.amd?define(["jef/events"],b):(a.jef=a.jef||{},a.jef.stream=b(a.jef.events))}(this,function(a,b){"use strict";function c(){var a,b=this.options.drain;for(this.options.drain=null;"undefined"!=typeof(a=b());)this.push(a)}function d(b){a.call(this),this.options=b||{},this.chain=[],this.buffer=[],this.filtered=!1,this.lastValue=[]}var e=Function.prototype.call.bind(Array.prototype.slice);return d.constructor=d,d.prototype=new a,d.prototype.hasReaders=function(){return this.eventsCallbacks>0},d.prototype.canDrain=function(){return"function"==typeof this.options.drain},d.prototype.on=function(b,c){var d=a.prototype.on.call(this,b,c);return this.trigger("drain"),d},d.prototype.pipe=function(a){if(!a instanceof d)throw new Error("You can pipe to another stream, but given "+a);return this.on("data",a.push.bind(a)),this.canDrain()?a.hasReaders()?(c.call(this),a):(a.on("drain",c.bind(this)),a):a},d.prototype.take=function(a,b,c){return this.chain.push(new d({take:{limit:a,skip:b||0,allowEmpty:!!c}})),this.chain[this.chain.length-1]},d.prototype.map=function(a){return this.chain.push(new d({apply:this.options.apply,map:a})),this.chain[this.chain.length-1]},d.prototype.accept=function(a){return this.chain.push(new d({apply:this.options.apply,filter:a})),this.chain[this.chain.length-1]},d.prototype.reject=function(a){return this.chain.push(new d({apply:this.options.apply,filter:function(){return!a.apply(a,arguments)}})),this.chain[this.chain.length-1]},d.prototype.reduce=function(a,b){return this.chain.push(new d({reduce:{func:a,base:b}})),this.chain[this.chain.length-1]},d.prototype.push=function(a){if(this.canDrain())throw new Error("Stream cant push data because it has drain function");if(a=e(arguments),this.filtered=!1,this.lastValue=[],this.options.filter&&!this.options.filter.apply(this.options.filter,a))return this.filtered=!0,this.trigger("out",a,this);if(this.options.map&&(a="function"==typeof this.options.map?this.options.map.apply(this,a):this.options.map,a=Array.isArray(a)?a:[a]),this.options.reduce&&(a=this.options.reduce.func.apply(this,a.concat(this.options.reduce.base)),this.options.reduce.base=a,a=Array.isArray(a)?a:[a]),this.options.take){this.buffer.push(a);var b=this.buffer.length,c=b-this.options.take.skip,d=c-this.options.take.limit;if(d=0>d?0:d,a=this.buffer.slice(d,c),!this.options.allowEmpty&&a.length!==this.options.take.limit)return this}return this.lastValue=a,this.trigger("data",a,this),this.chain.forEach(function(b){b.push.apply(b,a)}),this},d.prototype.last=function(a){return a.apply(a,this.lastValue),this.on("data",a),this},d.prototype.merge=function(a){return d.merge(this,a)},d.prototype.destroy=function(){this.options.destroy&&this.options.destroy(),this.chain.forEach(function(a){a.destroy()}),d.call(this)},d.merge=function(){var a=e(arguments),b=[],c=new d({destroy:function(){a.forEach(function(a,c){a.off("data",b[c])})}});return a.forEach(function(a,d){a.on("data",b[d]=function(){c.push.apply(c,arguments)})}),c},d.when=function(){var a=e(arguments),b=[],c=new Array(a.length),f=new Array(a.length),g=new d({filter:function(a){return-1===a.called.indexOf(!1)},map:function(a){return a.arguments},destroy:function(){a.forEach(function(a,c){a.off("out",b[c]),a.off("data",b[c])})}});return a.forEach(function(a,d){f[d]=!1,b[d]=function(a){f[d]=!this.filtered,c[d]=a,g.push({arguments:c,called:f})},a.on("out",b[d]),a.on("data",b[d]),g.lastValue.push(a.lastValue)}),g},d.fromArray=function(a){var c=-1,e=a.length,f=new d({drain:function(){return++c<e?a[c]:b}});return f},d.fromPromise=function(a,b){var c=b instanceof d?b:new d;return a.then(function(a){c.push(a)},function(){c.trigger("error",arguments)}),c},d});